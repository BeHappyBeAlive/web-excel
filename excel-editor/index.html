<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>new excel document</title>
	    <base href="/" />
        <!--[if IE]>
            <style type=text/css media=screen>@import url(./ie.css );</style>
        <![endif]-->
        <!--[if lte IE 7]>
            <style type="text/css" media="screen">
                @import url("./ie7.css");
            </style>    
        <![endif]-->
        <!--script type=text/javascript src="js/ext-base.js"></script-->
        <!--script type=text/javascript src="js/ext-all0.js"></script-->
        <link rel="stylesheet" type="text/css" href="/excel-editor/ext-2.2/resources/css/ext-all.css">
        <script type="text/javascript" src="/excel-editor/ext-2.2/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="/excel-editor/ext-2.2/ext-all.js"></script>
        <script type="text/javascript" src="/excel-editor/js/6excel.js"></script>
        <script type="text/javascript" src="/excel-editor/js/in-min.js"></script>
	    <script type="text/javascript" src="/javascripts/jquery-1.9.1.js"></script>
	    <script type="text/javascript" src="/javascripts/template.min.js"></script>
	    <script type="text/javascript" src="/javascripts/fileManage.js"></script>
	    <link rel="stylesheet" type="text/css" href="/stylesheets/fileManage.css">
        <link rel="stylesheet" type="text/css" href="/excel-editor/js/6excel.css">
		<link rel="stylesheet" href="/public/stylesheets/chat.css"/>
    </head>
    <body id="body" onload="load();">
        <div id="west"></div>
        <div id="north"></div>
        <div style="z-index: 50000; position: absolute" id="dialog-container"></div>
        <div id="center"></div>
        <div style="width: 200px; height: 200px; overflow: hidden" id="east"></div>
        <div id="south"></div>
        <div id='chatHeader' class="chatHeader">
            <a id='chatBtn' href="javascript:void(0);" class="chatBtn">聊天</a>
        </div>
        <div id='chatContainer' class="chatContainer">
            <div class="chatBanner" >
                <span class="count">&nbsp;当前协作人数：<span id='chatCount'>0</span></span>
                <div id='closeBtn' class="closeBtn"></div>
            </div>
            <div id='userCount' style=''></div>
            <div class='chatList_div'>
                <ul id='chatList' class="chatList"></ul>
yle='margin-left:13px; height:30px; width:370px'></textarea>
            <button id='sendBtn' style='margin:5px 0 0 13px ;'>发送</button>
            </div>
            <textarea id='chatContent' class="chatContent"></textarea>
            <button id='sendBtn' class="sendBtn">发送</button>
        </div>
        <script type="text/javascript">
        function load(){
            window.ogID = '' ;
            window.ogWID = '' ;

            var application = new Bao.Excel(document.body);
            In.add('dragCopy',{path:'/excel-editor/js/dragCopy.js',type:'js',charset:'utf-8'});
            In.ready('dragCopy',function() {
                dragCopy();
            });

            var online = true;
            if (navigator.onLine) {
                if (location.pathname.length > 1 && location.pathname !== '/index.html') {
                    //非新文档
                    doc = new Collaborate();
                } else {
                    //新文档
                    // if () {
                    //     //读缓存    
                    // }
                }                
            } else {
                //读离线缓存
            }
        }

        //非新文档建立链接和聊天工具
        function Collaborate () {
            //copy
            var me = this;

            //document info
            this.title = null;
            this.count = null;

            //websocket
            var url = 'ws://' + location.hostname + ':8080/' + location.pathname.replace(/\//g,''),
                socket = new WebSocket(url);
            
            socket.onmessage = function (message) {
                console.log(message);
                console.log(message.data);
                var mes = JSON.parse(message.data);
                if (mes.code != undefined) {
                    switch (mes.code) {
                        case 2 : 
                            //成功建立链接
                            console.log('opened');
                            me.title = mes.data.title;
                            me.count = mes.data.count;
                            document.title = me.title;
                            document.getElementById('chatCount').innerText = me.count;
                            break;
                        case 3:
                            //有新的协作者加入
                            me.count = mes.data.count;
                            document.getElementById('chatCount').innerText = me.count;
                            break;
						case 4:
                            //编辑状态更新

                            break;
                        case 1 :
                            //文档操作
                            if (mes.data instanceof Object) {
                                //文档被更新,可直接合并
                            } else {
                                //编辑成功
								console.log("同步成功");
                            }
                            break;
                        case 0 :
                            //聊天 
                            if (mes.data instanceof Object) {
                                chat.recieve(mes.data);
                            } else {
								//成功发送聊天信息
								console.log("成功发送聊天信息");
							}
                            break;
                        case -1 :
                            //存在冲突
                            break;
                        case -2 :
                            //同步失败,系统出错
							console.log("服务器同步失败");
							break;
                        case -3 :
                            //参数错误
							console.log("参数错误");
							break;
                        case -4 :
                            //系统错误
							console.log("系统错误");
							break;
                        default :
							break;
                    }
                }
            };

            socket.onerror = function (e){
                console.log(e);
            };

            //send sth.
            this.send = function (data) {
                socket.send(JSON.stringify(data));
            }({
				code : 5,
				data : document.cookie
			});

            //聊天工具
            var chat = {
                chat : this,
                init : function () {
                    //dom
                    var chatHeader = document.getElementById('chatHeader'),
                        chatBtn = document.getElementById('chatBtn'),
                        chatContainer = document.getElementById('chatContainer'),
                        chatList = document.getElementById('chatList'),
                        sendBtn = document.getElementById('sendBtn'),
                        closeBtn = document.getElementById('closeBtn'),
                        chatContent = document.getElementById('chatContent');

                    //event
                    chatBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        if (chatContainer.style.display == 'none') {
                            chatContainer.style.display = '';
                        } else {
                            chatContainer.style.display = 'none';
                        }
                    }, false);
                    closeBtn.addEventListener('click', function (e) {
                        chatContainer.style.display = 'none';
                    });
                    sendBtn.addEventListener('click', function (e) {
                        if (chatContent.value !== '') {
                            chat.send(chatContent.value);
                            chatContent.value = '';
                        } else {
                            //内容为空
                        }
                    });

                    chatHeader.style.display = '';
                },
                send : function (message) {
                    if (message !== '') {
                        this.createMes(message);
                        me.send({
                            "code" : 0,
                            "data" : {
                                "content" : encodeURIComponent(message),
								"userName" : COOKIE.get(document.cookie, "username")
                            }
                        });
                    }
                },
                recieve : function (message) {
                    if (message != undefined) {
                        this.createMes(decodeURIComponent(message.content), message.userName);
                    }
                },
                createMes : function (mes, user) {
                    user = user || '我';
                    var newChat = document.createElement('li');
                    newChat.class = 'chatLi';
                    newChat.innerHTML = '<span style="font-weight:600;">' + user + '：</span>' + mes;
                    chatList.appendChild(newChat);
                    chatList.scrollTop = (chatList.scrollHeight - chatList.clientHeight);
                }
            };
            chat.init();
        }

		var COOKIE = {
			get: function(cookie, name) {
				var ret = cookie.match(new RegExp("(?:^|;\\s)" + name + "=(.*?)(?:;\\s|$)"));
				return ret ? ret[1] : "";
			},set: function(cookie, key, value, opt) {
				var _date = new Date(), _domain = opt.domain || "localhost:3000", _path = opt.path || "/", _time_gap = opt.time || 10 * 365 * 24 * 3600 * 1000;
				_date.setTime(_date.getTime() + _time_gap);
				cookie = key + "=" + value + "; path=" + _path + "; domain=" + _domain + "; expires=" + _date.toUTCString();
			},del: function(cookie, key, opt) {
				var _opt = opt || {};
				opt.time = -new Date();
				cookie.set(key, '', opt);
			}
		};
        </script>
    </body>
</html>