<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>new excel document</title>
	    <base href="/" />
        <!--[if IE]>
            <style type=text/css media=screen>@import url(./ie.css );</style>
        <![endif]-->
        <!--[if lte IE 7]>
            <style type="text/css" media="screen">
                @import url("./ie7.css");
            </style>    
        <![endif]-->
        <!--script type=text/javascript src="js/ext-base.js"></script-->
        <!--script type=text/javascript src="js/ext-all0.js"></script-->
        <link rel="stylesheet" type="text/css" href="/excel-editor/ext-2.2/resources/css/ext-all.css">
		<script type="text/javascript">
			var COOKIE = {
				get: function (cookie, name) {
					var ret = cookie.match(new RegExp("(?:^|;\\s)" + name + "=(.*?)(?:;\\s|$)"));
					return ret ? ret[1] : "";
				},
				set: function (cookie, key, value, opt) {
					var _date = new Date(), _domain = opt.domain || "localhost:3000", _path = opt.path || "/", _time_gap = opt.time || 10 * 365 * 24 * 3600 * 1000;
					_date.setTime(_date.getTime() + _time_gap);
					cookie = key + "=" + value + "; path=" + _path + "; domain=" + _domain + "; expires=" + _date.toUTCString();
				},
				del: function (cookie, key, opt) {
					var _opt = opt || {};
					opt.time = -new Date();
					cookie.set(key, '', opt);
				}
			};

			function AJAX() {
				if (typeof XMLHttpRequest != "undefined") {
					return new XMLHttpRequest();
				} else if (typeof ActiveXObject != "undefined") {
					if (typeof arguments.callee.activeXString != "string") {
						var versions = ["MSXML2.XMLHttp.6.0", "MSXML2.XMLHttp.3.0", "MSXML2.XMLHttp"];
						for (var i = 0, len = versions.length; i < len; i++) {
							try {
								var xhr = new ActiveXObject(versions[i]);
								arguments.callee.activeXString = versions[i];
								return xhr;
							} catch (ex) {
								//不支持
							}
						}
					}
					return new ActiveXObject(arguments.callee.activeXString);
				} else {
					throw new Error("错误");
				}
			}
		</script>
        <script type="text/javascript" src="/excel-editor/ext-2.2/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="/excel-editor/ext-2.2/ext-all.js"></script>
        <script type="text/javascript" src="/excel-editor/js/6excel.js"></script>
        <script type="text/javascript" src="/excel-editor/js/in-min.js"></script>
	    <script type="text/javascript" src="/javascripts/jquery-1.9.1.js"></script>
	    <script type="text/javascript" src="/javascripts/template.min.js"></script>
	    <script type="text/javascript" src="/javascripts/fileManage.js"></script>
	    <link rel="stylesheet" type="text/css" href="/stylesheets/fileManage.css">
        <link rel="stylesheet" type="text/css" href="/excel-editor/js/6excel.css">
        <link rel="stylesheet" type="text/css" href="/excel-editor/css.css">
		<link rel="stylesheet" href="/stylesheets/chat.css"/>
    </head>
    <body id="body" onload="load();">
        <div id="west"></div>
        <div id="north"></div>
        <div style="z-index: 50000; position: absolute" id="dialog-container"></div>
        <div id="center"></div>
        <div style="width: 200px; height: 200px; overflow: hidden" id="east"></div>
        <div id="south"></div>
        <div id='chatHeader' class="chatHeader">
            <a id='chatBtn' href="javascript:void(0);" class="chatBtn">聊天</a>
			&nbsp;
			<span class="username" id="username"></span>
			&nbsp;
			<a class="logoutBtn" href="/user/logout" class="chatBtn">退出</a>
        </div>
		<div id="arrow" class="arrow"></div>
		<div id="arrow2" class="arrow2"></div>
        <div id='chatContainer' class="chatContainer">
            <div class="chatBanner" >
                <span class="count">&nbsp;当前协作人数：<span id='chatCount'>0</span></span>
                <div id='closeBtn' class="closeBtn"></div>
            </div>
            <div id='userCount' style=''></div>
            <div class='chatList_div'>
                <ul id='chatList' class="chatList"></ul>
            </div>
            <textarea id='chatContent' class="chatContent"></textarea>
            <button id='sendBtn' class="sendBtn">发送</button>
			<span id="warning" class="warning">内容不能为空</span>
        </div>
        <script type="text/javascript">
        function load(){
			var username = document.getElementById('username');
			username.textContent = '您好! ' + COOKIE.get(document.cookie, "username") || '游客';

			if (navigator.onLine) {
				if (location.pathname.length > 1 && location.pathname.indexOf('/doc/') != -1) {
					//文档id
					var docID = location.pathname.split('/')[2];
					localStorage.setItem('docID', docID);

					//非新文档
					doc = new Collaborate();

					//获取文件内容
					var xhr = AJAX(),
						url = '/file/getFileData?fileId=' + docID;

					xhr.open('GET', url, true);
					xhr.onreadystatechange = function () {
						if (xhr.readyState == 4 ) {
							if (xhr.status >= 200 && xhr.status < 300 || xhr.status == 304) {
								console.log(xhr.responseText);
								var data = JSON.parse(xhr.responseText);

								//加载文件内容
								document.title = data.fileName;
							}
							else {
								//出错
								alert('xhr : 系统出错, 请刷新页面');
							}
						}
					};
					xhr.send();
				} else {
					//新文档
					// if () {
					//     //读缓存
					//JsonManager.importCell(mes.data);
					// }
				}
			} else {
				//读离线缓存
			}

			window.ogID = '' ;
			window.ogWID = '' ;

            var application = new Bao.Excel(document.body);
            In.add('dragCopy',{path:'/excel-editor/js/dragCopy.js',type:'js',charset:'utf-8'});
            In.ready('dragCopy',function() {
                dragCopy();
            });

        }

        //非新文档建立链接和聊天工具
        function Collaborate () {
            //copy
            var me = this;

            //document info
            this.title = null;
            this.count = null;
			this.tmpl = '<div class="ActiveRange" id="userId">' +
							'<div class="AR_name_div">' +
								'<span class="AR_name">username</span>' +
							' </div>' +
					    	'<div class="AR_inner"></div>' +
					    '</div>';

            //websocket
            var url = 'ws://' + location.hostname + ':8080/' + location.pathname.replace(/\/doc\//g,''),
                socket = new WebSocket(url);

			socket.onopen = function () {
				me.send({
					"code" : 5,
					"data" : document.cookie
				});
			};

            socket.onmessage = function (message) {
                console.log(message);
                var mes = JSON.parse(message.data);
				console.log(mes);
                if (mes.code != undefined) {
                    switch (mes.code) {
                        case 2 :
                            //成功建立链接
                            console.log('opened with ' + mes.data.count +' people');
                            me.count = mes.data.count;
                            document.getElementById('chatCount').textContent = me.count;
                            break;

						case 3:
                            //有新的协作者加入
							console.log('新协作者' + mes.data.userName + '加入');
                            me.count = mes.data.count;
                            document.getElementById('chatCount').textContent = me.count;
                            break;

						case 4:
                            //编辑状态更新
							console.log(mes.data.userName + '更新了编辑状态');
							console.log(mes.data);
                            break;

                        case 1 :
                            //文档操作
                            if (mes.data instanceof Object) {
                                //文档被更新,可直接合并
								JsonManager.importCell(mes.data);
                            } else {
                                //编辑成功
								console.log("同步成功");
                            }
                            break;

                        case 0 :
                            //聊天
                            if (mes.data instanceof Object) {
                                chat.recieve(mes.data);
                            } else {
								//成功发送聊天信息
								console.log("成功发送聊天信息");
							}
                            break;

                        case -1 :
                            //存在冲突
							grid.diffSelector.addContent(mes.data);
							break;

                        case -2 :
                            //同步失败,系统出错
							console.log("服务器同步失败");
							alert(mes.error);
							break;

                        case -3 :
                            //参数错误
							console.log("参数错误");
							alert(mes.error);
							break;

                        case -4 :
                            //系统错误
							console.log("系统错误");
							alert(mes.error);
							break;

                        default :
							break;
                    }
                } else {
					alert("message : 系统出错，请刷新页面");
				}
            };

            socket.onerror = function (e){
				alert("socket : 系统出错，请刷新页面");
                console.log(e);
            };


			socket.onclose = function (e){
				alert("网络已断开");
				console.log(e);
			};

            //send sth.
            this.send = function (data) {
				if (data.code == 1) {
					data.data = JSON.parse(data.data);
				}
                socket.send(JSON.stringify(data));
            };

            //聊天工具
            var chat = {
                chat : this,
                init : function () {
                    //dom
                    var chatHeader = document.getElementById('chatHeader'),
                        chatBtn = document.getElementById('chatBtn'),
                        chatContainer = document.getElementById('chatContainer'),
                        chatList = document.getElementById('chatList'),
                        sendBtn = document.getElementById('sendBtn'),
                        closeBtn = document.getElementById('closeBtn'),
                        chatContent = document.getElementById('chatContent'),
						warning = document.getElementById('warning'),
						arrow = document.getElementById('arrow'),
						arrow2 = document.getElementById('arrow2');

                    //event
                    chatBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        if (chatContainer.style.display != 'block') {
                            chatContainer.style.display = 'block';
                            arrow.style.display = 'block';
							arrow2.style.display = 'block';
                        } else {
                            chatContainer.style.display = 'none';
							arrow.style.display = 'none';
							arrow2.style.display = 'none';
                        }
                    }, false);

                    closeBtn.addEventListener('click', function (e) {
                        chatContainer.style.display = 'none';
                    });

					chatContent.addEventListener('keydown', function (e) {
						if (e.ctrlKey && e.keyCode == 13) {
							sendBtn.click();
						}
					});

					var t;
                    sendBtn.addEventListener('click', function (e) {
                        if (chatContent.value !== '') {
                            chat.send(chatContent.value);
                            chatContent.value = '';
                        } else {
                            //内容为空
							warning.style.display = "inline-block";
							clearTimeout(t);
							t = setTimeout(function () {
								warning.style.display = "none";
							}, 2500);
                        }
                    });

                    chatBtn.style.visibility = 'visible';
                },

                send : function (message) {
                    if (message !== '') {
                        this.createMes(message);
                        me.send({
                            "code" : 0,
                            "data" : {
                                "content" : encodeURIComponent(message),
								"userName" : COOKIE.get(document.cookie, "username")
                            }
                        });
                    }
                },

                recieve : function (message) {
                    if (message != undefined) {
                        this.createMes(decodeURIComponent(message.content), message.userName);
                    }
                },

                createMes : function (mes, user) {
                    user = user || '我';
                    var newChat = document.createElement('li');
                    newChat.className = 'chatLi';
                    newChat.innerHTML = '<span style="font-weight:600;">' + user + '：</span>' + mes;
                    chatList.appendChild(newChat);
                    chatList.scrollTop = (chatList.scrollHeight - chatList.clientHeight);
                }
            };

            chat.init();

        }
        </script>
    </body>
</html>